<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIDI Sampler ‚Äì Browser</title>
  <meta name="description" content="Mapeie notas MIDI para tocar seus pr√≥prios √°udios no navegador." />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #131a2a;
      --muted: #8ea1b2;
      --text: #e9eef4;
      --accent: #4cc9f0;
      --accent-2: #a3ffb8;
      --danger: #ff6b6b;
      --ring: rgba(76, 201, 240, .35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text); background: radial-gradient(1200px 1200px at 110% -10%, #162036, var(--bg));
    }
    .container { max-width: 980px; margin: 32px auto; padding: 0 16px 48px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 16px; }
    h1 { font-size: clamp(22px, 4vw, 32px); margin:0; letter-spacing: .3px; }
    .badge { font-size: 12px; color: var(--bg); background: var(--accent-2); padding: 4px 8px; border-radius: 999px; font-weight: 700; }

    .card { background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); padding: 16px; box-shadow: 0 20px 40px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.03); }
    .row { display:flex; flex-wrap:wrap; gap: 12px; align-items:center; }
    .row > * { flex: none; }
    .grow { flex: 1 1 auto; }

    button, select, input[type="file"] {
      background: #0f1526; border: 1px solid rgba(255,255,255,.1); color: var(--text);
      padding: 10px 12px; border-radius: 12px; font-size: 14px; outline: none;
    }
    button { cursor: pointer; font-weight: 700; letter-spacing:.2px; }
    button.primary { background: linear-gradient(180deg, #1b2a46, #15243e); border-color: rgba(76,201,240,.45); box-shadow: 0 0 0 0 rgba(76,201,240,.35); }
    button.primary:hover { box-shadow: 0 0 0 4px var(--ring); }
    button.ghost { background: transparent; border-color: rgba(255,255,255,.15); }
    button.danger { border-color: rgba(255,107,107,.45); background: linear-gradient(180deg, rgba(255,107,107,.15), rgba(255,107,107,.08)); }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .status { font-size: 13px; color: var(--muted); }
    .hint { font-size: 12px; color: var(--muted); }

    .list { margin-top: 16px; display: grid; gap: 10px; }
    .item { display:grid; grid-template-columns: 1fr auto auto auto; gap: 8px; align-items:center; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.08); }
    .note { font-weight: 800; letter-spacing:.3px; display:flex; align-items:center; gap:8px; }
    .stop-badge { padding:2px 8px; border-radius: 999px; background: rgba(255,107,107,.15); border:1px solid rgba(255,107,107,.45); font-size:11px; font-weight:800; letter-spacing:.3px; }

    .small { font-size: 12px; color: var(--muted); }
    .kbd { border: 1px solid rgba(255,255,255,.2); padding: 1px 6px; border-radius: 6px; background: #0b1120; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }

    dialog { width: min(640px, 96%); background: #0b1120; border: 1px solid rgba(255,255,255,.12); color: var(--text); border-radius: 16px; box-shadow: 0 30px 80px rgba(0,0,0,.6); }
    dialog::backdrop { background: rgba(0,0,0,.55); }
    .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,.08);} 
    .modal-body { padding: 16px; display: grid; gap: 12px; }
    .field { display:grid; gap: 6px; }
    label { font-size: 13px; color: var(--muted); }
    .footer { display:flex; justify-content:flex-end; gap: 8px; padding: 12px 16px; border-top: 1px solid rgba(255,255,255,.08);} 

    #panicBtn { position: fixed; bottom: 20px; right: 20px; background: red; color: white; border: none; border-radius: 50%; width: 70px; height: 70px; font-size: 14px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>MIDI Sampler</h1>
        <div class="hint">Mapeie notas MIDI para tocar √°udios personalizados.</div>
      </div>
      <span class="badge">Beta</span>
    </header>

    <section class="card" id="gate">
      <div class="row" style="align-items:flex-start">
        <div class="grow">
          <div class="status" id="status">Permiss√£o MIDI necess√°ria.</div>
          <div class="hint">Conecte seu controlador MIDI e clique em <b>Ativar MIDI</b>. Clique em <b>Desmutar √Åudio</b> ap√≥s a primeira intera√ß√£o.</div>
        </div>
        <div class="row">
          <button class="primary" id="enableMidiBtn">Ativar MIDI</button>
          <button class="ghost" id="unlockAudioBtn">Desmutar √Åudio</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px;">
      <div class="row">
        <button class="primary" id="addBtn">Adicionar mapeamento</button>
        <button class="ghost" id="clearAllBtn">Limpar todos</button>
        <button class="ghost" id="setStopBtn">üö® Definir STOP</button>
        <span class="grow"></span>
        <span class="status" id="insInfo">Nenhuma entrada MIDI.</span>
      </div>
      <div id="stopNoteDisplay" class="hint"></div>
      <div class="list" id="mappingList"></div>
    </section>

    <dialog id="mappingDialog">
      <form method="dialog" id="mappingForm">
        <div class="modal-header">
          <strong>Novo mapeamento</strong>
          <button class="ghost" value="cancel">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="field">
            <label>Nota MIDI</label>
            <div class="row">
              <select id="noteSelect"></select>
              <button type="button" class="ghost" id="listenBtn">Ouvir nota</button>
              <span id="listenBadge" class="kbd" style="display:none">Escutando‚Ä¶ toque uma tecla</span>
            </div>
            <div class="hint">Voc√™ pode escolher pela lista ou tocar a nota no seu teclado MIDI.</div>
          </div>
          <div class="field">
            <label>√Åudio (upload)</label>
            <input type="file" id="fileInput" accept="audio/*" />
            <div class="row">
              <span id="fileName" class="small">Nenhum arquivo escolhido.</span>
              <span class="grow"></span>
              <button type="button" id="testLocalBtn" class="ghost" disabled>‚ñ∂Ô∏è Testar √°udio</button>
            </div>
            <div class="hint">Formatos comuns: WAV, MP3, OGG, M4A. Os arquivos ficam salvos no seu navegador (IndexedDB).</div>
          </div>
        </div>
        <div class="footer">
          <button value="cancel" class="ghost">Cancelar</button>
          <button id="saveBtn" class="primary" disabled>Salvar</button>
        </div>
      </form>
    </dialog>
  </div>

  <button id="panicBtn">STOP</button>

  <script>
    // =====================
    // Utilidades
    // =====================
    function noteToName(n) {
      const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const name = names[n % 12];
      const octave = Math.floor(n / 12) - 1;
      return `${name}${octave} (${n})`;
    }

    function uid() {
      return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 8);
    }

    // =====================
    // √Åudio
    // =====================
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    masterGain.connect(audioCtx.destination);

    async function resumeAudio() {
      try { if (audioCtx.state !== 'running') await audioCtx.resume(); } catch(e){}
    }

    let activeSources = [];
    function playBuffer(audioBuffer) {
      const src = audioCtx.createBufferSource();
      src.buffer = audioBuffer;
      src.connect(masterGain);
      src.start();
      activeSources.push(src);
      src.onended = () => { activeSources = activeSources.filter(s => s !== src); };
    }
    function stopAllSounds() {
      activeSources.forEach(s => { try { s.stop(); } catch(e){} });
      activeSources = [];
    }
    document.getElementById('panicBtn').onclick = stopAllSounds;

    // =====================
    // Persist√™ncia (localStorage + IndexedDB)
    // =====================
    const MAP_KEY = 'midi-sampler:mappings:v2'; // { [note]: { id, name } }
    const STOP_KEY = 'midi-sampler:stopNote:v1';

    function loadMappings() {
      try { return JSON.parse(localStorage.getItem(MAP_KEY)) || {}; } catch { return {}; }
    }
    function saveMappings(m) { localStorage.setItem(MAP_KEY, JSON.stringify(m)); }
    function loadStopNote() { const v = localStorage.getItem(STOP_KEY); return v === null ? null : Number(v); }
    function saveStopNote(n) { if (n === null) localStorage.removeItem(STOP_KEY); else localStorage.setItem(STOP_KEY, String(n)); }

    const state = {
      mappings: loadMappings(),           // { [note:number]: { id:string, name:string } }
      decodedBuffers: new Map(),          // id -> AudioBuffer
      stopNote: loadStopNote(),
    };

    let db; const DB_NAME='midi-sampler-db', STORE_NAME='samples';
    function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME,{keyPath:'id'}); }; r.onsuccess=()=>{ db=r.result; res(db); }; r.onerror=()=>rej(r.error); }); }
    function setSample(id,data){ return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).put({id,data}); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    function getSample(id){ return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readonly'); const rq=tx.objectStore(STORE_NAME).get(id); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }); }
    function deleteSample(id){ return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).delete(id); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
    function clearAllSamples(){ return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).clear(); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }

    async function loadAndCacheSample(sampleId) {
      const rec = await getSample(sampleId);
      if (!rec) throw new Error('Sample n√£o encontrado');
      const buf = await audioCtx.decodeAudioData(rec.data.slice(0));
      state.decodedBuffers.set(sampleId, buf);
      return buf;
    }

    // =====================
    // UI refs
    // =====================
    const statusEl = document.getElementById('status');
    const enableMidiBtn = document.getElementById('enableMidiBtn');
    const unlockAudioBtn = document.getElementById('unlockAudioBtn');
    const addBtn = document.getElementById('addBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const setStopBtn = document.getElementById('setStopBtn');
    const insInfo = document.getElementById('insInfo');
    const listEl = document.getElementById('mappingList');
    const stopNoteDisplay = document.getElementById('stopNoteDisplay');

    const dlg = document.getElementById('mappingDialog');
    const noteSelect = document.getElementById('noteSelect');
    const listenBtn = document.getElementById('listenBtn');
    const listenBadge = document.getElementById('listenBadge');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const testLocalBtn = document.getElementById('testLocalBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Popular notas 0..127
    for (let i = 0; i <= 127; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = noteToName(i);
      noteSelect.appendChild(opt);
    }

    // =====================
    // MIDI
    // =====================
    let midiAccess = null;
    let inputCount = 0;
    let listeningForNote = false;
    let waitingForStopNote = false;

    async function enableMIDI() {
      if (!('requestMIDIAccess' in navigator)) {
        statusEl.textContent = 'Este navegador n√£o suporta Web MIDI.';
        enableMidiBtn.disabled = true;
        return;
      }
      try {
        midiAccess = await navigator.requestMIDIAccess({ sysex:false });
        midiAccess.onstatechange = refreshInputs;
        refreshInputs();
        statusEl.textContent = 'MIDI ativado!';
      } catch (e) {
        statusEl.textContent = 'Permiss√£o MIDI negada.';
      }
    }

    function refreshInputs() {
      inputCount = 0;
      for (const input of midiAccess.inputs.values()) {
        input.onmidimessage = onMIDIMessage;
        inputCount++;
      }
      insInfo.textContent = inputCount > 0 ? `${inputCount} entrada(s) MIDI conectada(s).` : 'Nenhuma entrada MIDI.';
    }

    function onMIDIMessage(e) {
      const [status, note, velocity] = e.data;
      const cmd = status & 0xf0;

      if (cmd === 0x90 && velocity > 0) { // Note On
        // Configurar STOP
        if (waitingForStopNote) {
          state.stopNote = note;
          saveStopNote(note);
          waitingForStopNote = false;
          updateStopDisplay();
          return;
        }
        // Acionar STOP
        if (state.stopNote !== null && note === state.stopNote) {
          stopAllSounds();
          return;
        }
        // Capturar nota para o di√°logo
        if (listeningForNote) {
          noteSelect.value = String(note);
          toggleListen(false);
        }
        // Tocar sample mapeado
        const m = state.mappings[note];
        const sampleId = m && (m.id || m); // compat v1
        if (sampleId) {
          const buf = state.decodedBuffers.get(sampleId);
          if (buf) { playBuffer(buf); }
          else { loadAndCacheSample(sampleId).then(playBuffer).catch(()=>{}); }
        }
      }
    }

    // =====================
    // UI actions
    // =====================
    enableMidiBtn.onclick = async () => { await resumeAudio(); enableMIDI(); };
    unlockAudioBtn.onclick = resumeAudio;

    addBtn.onclick = () => {
      selectedFileData = null;
      selectedFileName = '';
      fileInput.value = '';
      fileName.textContent = 'Nenhum arquivo escolhido.';
      saveBtn.disabled = true;
      testLocalBtn.disabled = true;
      noteSelect.value = '60';
      dlg.showModal();
    };

    clearAllBtn.onclick = async () => {
      if (!confirm('Apagar todos os mapeamentos e √°udios?')) return;
      state.mappings = {};
      saveMappings(state.mappings);
      state.decodedBuffers.clear();
      try { await clearAllSamples(); } catch(e){}
      renderList();
    };

    setStopBtn.onclick = () => {
      waitingForStopNote = true;
      stopNoteDisplay.textContent = 'Toque a nota/bot√£o no seu controlador para configurar como STOP.';
    };

    listenBtn.onclick = () => toggleListen(true);

    function toggleListen(on) {
      listeningForNote = on;
      listenBadge.style.display = on ? 'inline-block' : 'none';
      listenBtn.disabled = on;
    }

    function updateStopDisplay() {
      if (state.stopNote === null) {
        stopNoteDisplay.textContent = '';
      } else {
        stopNoteDisplay.textContent = `Nota de parada: ${noteToName(state.stopNote)}`;
      }
      renderList();
    }

    // =====================
    // Upload / salvar mapeamento
    // =====================
    let selectedFileData = null;
    let selectedFileName = '';

    fileInput.onchange = () => {
      const f = fileInput.files[0];
      if (!f) return;
      selectedFileName = f.name;
      fileName.textContent = f.name;
      saveBtn.disabled = false;
      testLocalBtn.disabled = false;
      const reader = new FileReader();
      reader.onload = () => { selectedFileData = reader.result; };
      reader.readAsArrayBuffer(f);
    };

    testLocalBtn.onclick = async () => {
      if (!selectedFileData) return;
      await resumeAudio();
      const buf = await audioCtx.decodeAudioData(selectedFileData.slice(0));
      playBuffer(buf);
    };

    saveBtn.onclick = async (e) => {
      e.preventDefault();
      const note = Number(noteSelect.value);
      if (!selectedFileData) return;
      const id = uid();
      await setSample(id, selectedFileData);
      state.mappings[note] = { id, name: selectedFileName || id };
      saveMappings(state.mappings);
      try {
        const buf = await audioCtx.decodeAudioData(selectedFileData.slice(0));
        state.decodedBuffers.set(id, buf);
      } catch(e){}
      dlg.close();
      renderList();
    };

    // =====================
    // Renderiza√ß√£o da lista
    // =====================
    function renderList() {
      listEl.innerHTML = '';
      const entries = Object.entries(state.mappings).sort((a,b)=> Number(a[0]) - Number(b[0]));
      if (entries.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'hint';
        empty.textContent = 'Nenhum mapeamento ainda. Clique em ‚ÄúAdicionar mapeamento‚Äù.';
        listEl.appendChild(empty);
        return;
      }
      for (const [noteStr, info] of entries) {
        const note = Number(noteStr);
        const item = document.createElement('div');
        item.className = 'item';

        const left = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'note';
        title.textContent = noteToName(note);
        if (state.stopNote !== null && note === state.stopNote) {
          const badge = document.createElement('span');
          badge.className = 'stop-badge';
          badge.textContent = 'STOP';
          title.appendChild(badge);
        }
        const small = document.createElement('div');
        small.className = 'small';
        const sampleId = info && (info.id || info); // compat v1
        const sampleName = info && info.name ? info.name : `ID: ${sampleId}`;
        small.textContent = sampleName;
        left.appendChild(title);
        left.appendChild(small);

        const testBtn = document.createElement('button');
        testBtn.className = 'ghost';
        testBtn.textContent = '‚ñ∂Ô∏è';
        testBtn.title = 'Testar';
        testBtn.onclick = async () => {
          await resumeAudio();
          const buf = state.decodedBuffers.get(sampleId) || await loadAndCacheSample(sampleId);
          playBuffer(buf);
        };

        const changeBtn = document.createElement('button');
        changeBtn.className = 'ghost';
        changeBtn.textContent = 'Trocar √°udio';
        changeBtn.onclick = () => {
          // Abre o di√°logo com a nota j√° escolhida para trocar apenas o sample
          noteSelect.value = String(note);
          selectedFileData = null;
          selectedFileName = '';
          fileInput.value = '';
          fileName.textContent = 'Nenhum arquivo escolhido.';
          saveBtn.disabled = true;
          testLocalBtn.disabled = true;
          dlg.showModal();
        };

        const removeBtn = document.createElement('button');
        removeBtn.className = 'danger';
        removeBtn.textContent = 'Remover';
        removeBtn.onclick = async () => {
          if (!confirm('Remover este mapeamento?')) return;
          delete state.mappings[note];
          saveMappings(state.mappings);
          // Opcional: remover o sample do banco (apenas se nenhum outro mapeamento usa o mesmo id)
          const stillUsed = Object.values(state.mappings).some(v => (v.id||v) === sampleId);
          if (!stillUsed) {
            try { await deleteSample(sampleId); } catch(e){}
            state.decodedBuffers.delete(sampleId);
          }
          renderList();
        };

        item.appendChild(left);
        item.appendChild(testBtn);
        item.appendChild(changeBtn);
        item.appendChild(removeBtn);
        listEl.appendChild(item);
      }
    }

    // =====================
    // Inicializa√ß√£o
    // =====================
    function warmCache() {
      const ids = new Set(Object.values(state.mappings).map(v => (v.id || v)));
      ids.forEach(id => { if (!state.decodedBuffers.has(id)) loadAndCacheSample(id).catch(()=>{}); });
    }

    openDB().then(() => {
      updateStopDisplay();
      renderList();
      warmCache();
    });
  </script>
</body>
</html>
